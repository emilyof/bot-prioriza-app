from unittest.mock import Mock

import pytest

from app.core.vulnerability_types import VulnerabilityType
from app.services.vulnerability_service import VulnerabilityService

# ==========================================================
# FIXTURES
# ==========================================================


@pytest.fixture
def ai_service_mock():
    ai = Mock()
    ai.calculate_technical_score_by_description.return_value = {
        "technical_subtotal": 45.0,
        "justification": "Alta criticidade técnica identificada",
    }
    return ai


@pytest.fixture
def owasp_service_mock():
    service = Mock()

    # Categoria válida (TOP 10)
    valid_category = Mock()
    valid_category.code = "A01"
    valid_category.title = "Broken Access Control"
    valid_category.rank = 1

    service.resolve_by_code.side_effect = lambda code: (valid_category if code == "A01" else None)

    return service


@pytest.fixture
def vulnerability_service(ai_service_mock, owasp_service_mock):
    return VulnerabilityService(
        ai_service=ai_service_mock,
        owasp_service=owasp_service_mock,
    )


# ==========================================================
# TESTES — SCORING POR DESCRIÇÃO (IA)
# ==========================================================


def test_calculate_score_by_description_success(vulnerability_service):
    result = vulnerability_service.calculate_technical_score(
        identifier="Remote Code Execution without authentication",
        input_type=VulnerabilityType.AI_SCORING_DESCRIPTION,
        user_id="U1",
    )

    assert result is not None
    assert result["technical_subtotal"] == 45.0
    assert result["description_ai"] == "Remote Code Execution without authentication"
    assert "ai_justification" in result


def test_calculate_score_by_description_without_ai_service():
    service = VulnerabilityService(ai_service=None)

    result = service.calculate_technical_score(
        identifier="Some vulnerability description",
        input_type=VulnerabilityType.AI_SCORING_DESCRIPTION,
        user_id="U1",
    )

    assert result is None


# ==========================================================
# TESTES — SCORING OWASP
# ==========================================================


def test_calculate_score_owasp_valid_category(vulnerability_service):
    result = vulnerability_service.calculate_technical_score(
        identifier="A01",
        input_type=VulnerabilityType.OWASP,
        user_id="U1",
    )

    assert result is not None
    assert result["technical_subtotal"] == 60.0
    assert result["description_ai"] == "Broken Access Control"
    assert "Pontuação técnica baseada" in result["score_explanation"]


def test_calculate_score_owasp_out_of_top10(vulnerability_service):
    result = vulnerability_service.calculate_technical_score(
        identifier="A99",
        input_type=VulnerabilityType.OWASP,
        user_id="U1",
    )

    assert result is None


def test_calculate_score_owasp_invalid_format(vulnerability_service):
    result = vulnerability_service.calculate_technical_score(
        identifier="OWASP-01",
        input_type=VulnerabilityType.OWASP,
        user_id="U1",
    )

    assert result is None


# ==========================================================
# TESTES — SCORING CVE (DEFENSIVO)
# ==========================================================


def test_calculate_score_cve_invalid_format(vulnerability_service):
    result = vulnerability_service.calculate_technical_score(
        identifier="INVALID-CVE",
        input_type=VulnerabilityType.CVE,
        user_id="U1",
    )

    assert result is None


def test_calculate_score_cve_valid_but_not_found(monkeypatch, vulnerability_service):
    monkeypatch.setattr(
        vulnerability_service,
        "get_nist_nvd_data",
        lambda _: None,
    )

    result = vulnerability_service.calculate_technical_score(
        identifier="CVE-2024-0001",
        input_type=VulnerabilityType.CVE,
        user_id="U1",
    )

    assert result is not None
    assert result["technical_subtotal"] == 0.0
    assert result["cvss_status"] == "AWAITING_ANALYSIS"


# ==========================================================
# TESTES — TIPO DESCONHECIDO
# ==========================================================


def test_calculate_score_unknown_type(vulnerability_service):
    result = vulnerability_service.calculate_technical_score(
        identifier="X01",
        input_type="UNKNOWN_TYPE",  # type: ignore
        user_id="U1",
    )

    assert result is None
